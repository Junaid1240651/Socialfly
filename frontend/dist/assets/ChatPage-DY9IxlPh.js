import{f as D,j as e,q as b,y as P,r as p,g as q,d as g,e as R,V as X,F as o,k as L,a5 as G,T as w,W as I,B as M,a6 as N,a7 as H,U as O,c as A,u as B,_ as Z,t as J,I as E,$ as K,a0 as Q,a1 as ee,a2 as se,a3 as te,S as re,b as z,a8 as C,a as ae}from"./index-JVrb99rO.js";import{S as ne}from"./chunk-ZHMYA64R-B818bYut.js";import{u as oe,A as k}from"./chunk-V7PAE35Z-D2UZjn2e.js";import{a as _,S as W}from"./chunk-W7A7QDAK-BBIKUkVy.js";import{I as ie,a as le}from"./chunk-2ZHRCML3-Bn-nqrvE.js";import{M as ce}from"./chunk-JQMJHPZH-BRDday_i.js";import{D as de}from"./chunk-W7WUSNWJ-DB38mfw_.js";var xe={"top-start":{top:"0",insetStart:"0",transform:"translate(-25%, -25%)"},"top-end":{top:"0",insetEnd:"0",transform:"translate(25%, -25%)"},"bottom-start":{bottom:"0",insetStart:"0",transform:"translate(-25%, 25%)"},"bottom-end":{bottom:"0",insetEnd:"0",transform:"translate(25%, 25%)"}},V=D(function(t,n){const{placement:a="bottom-end",className:i,...u}=t,c=oe(),h={position:"absolute",display:"flex",alignItems:"center",justifyContent:"center",...xe[a],...c.badge};return e.jsx(b.div,{ref:n,...u,className:P("chakra-avatar__badge",i),__css:h})});V.displayName="AvatarBadge";var ue=D(function(t,n){const{spacing:a="0.5rem",spacingX:i,spacingY:u,children:c,justify:f,direction:h,align:m,className:j,shouldWrapChildren:S,...v}=t,r=p.useMemo(()=>S?p.Children.map(c,(d,s)=>e.jsx(T,{children:d},s)):c,[c,S]);return e.jsx(b.div,{ref:n,className:P("chakra-wrap",j),...v,children:e.jsx(b.ul,{className:"chakra-wrap__list",__css:{display:"flex",flexWrap:"wrap",justifyContent:f,alignItems:m,flexDirection:h,listStyleType:"none",gap:a,columnGap:i,rowGap:u,padding:"0"},children:r})})});ue.displayName="Wrap";var T=D(function(t,n){const{className:a,...i}=t;return e.jsx(b.li,{ref:n,__css:{display:"flex",alignItems:"flex-start"},className:P("chakra-wrap__listitem",a),...i})});T.displayName="WrapItem";var me=q({d:"M23.384,21.619,16.855,15.09a9.284,9.284,0,1,0-1.768,1.768l6.529,6.529a1.266,1.266,0,0,0,1.768,0A1.251,1.251,0,0,0,23.384,21.619ZM2.75,9.5a6.75,6.75,0,1,1,6.75,6.75A6.758,6.758,0,0,1,2.75,9.5Z",displayName:"SearchIcon"});const he=({conversation:x,isOnline:t})=>{const n=x.participants[0],a=x.lastMessage,i=g(h=>h.user.userInfo),u=g(h=>h.conversation.getSelectedConversation),c=R(),f=X();return e.jsxs(o,{gap:4,alignItems:"center",p:"1",_hover:{cursor:"pointer",bg:L("gray.600","gray.dark"),color:"white"},borderRadius:"md",onClick:()=>c(G({_id:x._id,userId:n._id,userProfilePic:n.profilePic,userName:n.userName,mock:x.mock})),bg:(u==null?void 0:u._id)===x._id?f==="light"?"gray.400":"gray.dark":"",children:[e.jsx(T,{children:e.jsx(k,{size:{base:"xs",sm:"sm",md:"md"},src:n.profilePic,children:t?e.jsx(V,{boxSize:"1em",bg:"green.500"}):""})}),e.jsxs(ne,{direction:"column",fontSize:"sm",children:[e.jsxs(w,{fontWeight:"700",display:"flex",alignItems:"center",children:[n.userName," ",e.jsx(I,{src:"/verified.png",w:4,h:4,ml:1})]}),e.jsxs(o,{alignItems:"center",fontSize:"xs",gap:1,children:[i._id===a.sender&&e.jsx(M,{color:a.seen?"blue.400":"",children:e.jsx(N,{size:16})}),e.jsx(w,{children:a.text.length>18?a.text.substring(0,18)+"...":a.text||e.jsx(H,{size:16})})]})]})]})};function pe(x){return O({tag:"svg",attr:{viewBox:"0 0 512 512"},child:[{tag:"path",attr:{d:"M211.313 21.094c-51.776 0-98.754 12.252-133.5 32.718C43.066 74.28 19.874 103.78 19.874 137.69c0 33.54 22.692 62.81 56.813 83.25L48.156 327.094l96.97-79.844c20.65 4.58 42.924 7.063 66.186 7.063 51.776 0 98.786-12.252 133.532-32.72 34.746-20.466 57.937-49.997 57.937-83.905s-23.19-63.41-57.936-83.875c-34.746-20.467-81.756-32.72-133.53-32.72zm0 18.687c48.8 0 92.866 11.77 124.03 30.126 31.165 18.357 48.75 42.447 48.75 67.78 0 25.338-17.585 49.457-48.75 67.814-31.164 18.357-75.23 30.125-124.03 30.125S118.445 223.857 87.28 205.5c-31.163-18.357-48.718-42.476-48.718-67.813 0-25.336 17.555-49.424 48.72-67.78C118.445 51.55 162.51 39.78 211.31 39.78zM96.53 89.938v18.688h93.126V89.937H96.53zm111.814 0v18.688h28.094V89.937h-28.094zm46.78 0v18.688h71.97V89.937h-71.97zM96.532 129.844v18.72h29.657v-18.72H96.53zm48.345 0v18.72h65.938v-18.72h-65.938zm84.656 0v18.72h38.095v-18.72H229.53zm56.782 0v18.72h40.782v-18.72h-40.78zM96.532 166.78v18.69h70.874v-18.69H96.53zm89.562 0v18.69h57.03v-18.69h-57.03zm75.72 0l-.002 18.69h65.282v-18.69h-65.28zm92.342 90.25c-74.88 0-135.594 41.762-135.594 93.283 0 51.52 60.716 93.28 135.594 93.28 18.23 0 35.623-2.48 51.5-6.968l68.53 51.156-24.873-71.03c24.947-16.918 40.437-40.432 40.437-66.438 0-51.518-60.714-93.28-135.594-93.28zm-70.344 42.345h32.907v18.688H283.81v-18.688zm51.594 0h90.344v18.688h-90.344v-18.688zm-78.97 41.75h78.314v18.688h-78.313v-18.688zm97.002 0h20.968v18.688h-20.97l.002-18.688zm39.656 0h51v18.688h-51v-18.688zm-109.28 39h79.06v18.688h-79.062v-18.688zm97.748 0h44.188v18.688h-44.188v-18.688z"},child:[]}]})(x)}const ge=({ownMessage:x,message:t})=>{const n=g(c=>c.conversation.getSelectedConversation),a=g(c=>c.user.userInfo),{isLoading:i,setLoading:u}=A();return e.jsx(e.Fragment,{children:x?e.jsxs(o,{gap:2,alignSelf:"flex-end",children:[t.text&&e.jsxs(o,{bg:"green.800",maxW:"350px",p:1,borderRadius:"md",children:[e.jsx(w,{color:"white",children:t.text}),e.jsx(M,{alignSelf:"flex-end",ml:1,color:t.seen?"blue.400":"",fontWeight:"bold",children:e.jsx(N,{size:16})})]}),t.img&&!i&&e.jsxs(o,{mt:5,w:"200px",children:[e.jsx(I,{src:t.img,hidden:!0,onLoad:()=>u(!0),alt:"Message image",borderRadius:4}),e.jsx(_,{w:"200px",h:"200px"})]}),t.img&&i&&e.jsxs(o,{mt:5,w:"200px",children:[e.jsx(I,{src:t.img,alt:"Message image",borderRadius:4}),e.jsx(M,{alignSelf:"flex-end",ml:1,color:t.seen?"blue.400":"",fontWeight:"bold",children:e.jsx(N,{size:16})})]}),e.jsx(k,{src:a.profilePic,w:"7",h:7})]}):e.jsxs(o,{gap:2,children:[e.jsx(k,{src:n.userProfilePic,w:"7",h:7}),t.text&&e.jsx(w,{maxW:"350px",bg:"gray.400",p:1,borderRadius:"md",color:"black",children:t.text}),t.img&&!i&&e.jsxs(o,{mt:5,w:"200px",children:[e.jsx(I,{src:t.img,hidden:!0,onLoad:()=>u(!0),alt:"Message image",borderRadius:4}),e.jsx(_,{w:"200px",h:"200px"})]}),t.img&&i&&e.jsx(o,{mt:5,w:"200px",children:e.jsx(I,{src:t.img,alt:"Message image",borderRadius:4})})]})})};function F(x){return O({tag:"svg",attr:{viewBox:"0 0 512 512"},child:[{tag:"path",attr:{d:"m16 464 480-208L16 48v160l320 48-320 48z"},child:[]}]})(x)}const fe=({setMessages:x})=>{const[t,n]=p.useState(""),a=B(),i=p.useRef(null),{onClose:u}=Z(),c=R(),{isLoading:f,setLoading:h}=A(),{handleImageChange:m,imageURL:j,setImageURL:S}=J(),v=g(s=>s.conversation.getSelectedConversation),r=g(s=>s.conversation.getConversation),d=async s=>{if(s.preventDefault(),!(!t&&!j)&&!f){h(!0);try{const l=await z.post("./api/messages",{message:t,recipientId:v.userId,img:j});x(y=>[...y,l.data]),c(C(r.map(y=>y._id===v._id?{...y,lastMessage:{text:t,sender:l.data.sender}}:y))),n(""),S("")}catch(l){a("Error",l.response.data.error,"error")}finally{h(!1)}}};return e.jsxs(o,{gap:2,alignItems:"center",children:[e.jsx("form",{onSubmit:d,style:{flex:95},children:e.jsxs(ie,{children:[e.jsx(E,{w:"full",placeholder:"Type a message",onChange:s=>n(s.target.value),value:t}),e.jsx(le,{onClick:d,cursor:"pointer",children:e.jsx(F,{})})]})}),e.jsxs(o,{flex:5,cursor:"pointer",children:[e.jsx(H,{size:20,onClick:()=>i.current.click()}),e.jsx(E,{type:"file",hidden:!0,ref:i,onChange:m})]}),e.jsxs(K,{isOpen:j,onClose:()=>{u(),S("")},children:[e.jsx(ce,{}),e.jsxs(Q,{children:[e.jsx(ee,{}),e.jsx(se,{}),e.jsxs(te,{children:[e.jsx(o,{mt:5,w:"full",children:e.jsx(I,{src:j})}),e.jsx(o,{justifyContent:"flex-end",my:2,children:f?e.jsx(re,{size:"md"}):e.jsx(F,{size:24,cursor:"pointer",onClick:d})})]})]})]})]})},je="/assets/message-qhDe3lRG.mp3",ve=()=>{const x=B(),[t,n]=p.useState(!0),[a,i]=p.useState([]),u=g(r=>r.user.userInfo),c=g(r=>r.socketio.socket),f=R(),h=p.useRef(null),m=g(r=>r.conversation.getSelectedConversation),j=g(r=>r.conversation.getConversation),S=async()=>{n(!0),i([]);try{if(m.mock)return;const r=await z.get(`/api/messages/${m.userId}`);i(r.data)}catch(r){x("Error",r.response.data.error,"error")}finally{n(!1)}},v=async()=>{c.on("newMessage",r=>{m._id===r.conversationId&&i(d=>[...d,r]),document.hasFocus()||new Audio(je).play(),f(C(j.map(d=>d._id===m._id?{...d,lastMessage:{text:r.text,sender:r.sender}}:d)))})};return p.useEffect(()=>{a.length&&a[a.length-1].sender!==u._id&&c.emit("markMessagesAsSeen",{conversationId:m._id,userId:m.userId}),c.on("messagesSeen",({conversationId:d})=>{m._id===d&&i(s=>s.map(y=>y.seen?y:{...y,seen:!0}))})},[c,u._id,a,m]),p.useEffect(()=>(v(),()=>c.off("newMessage")),[c,m]),p.useEffect(()=>{var r;(r=h.current)==null||r.scrollIntoView({behavior:"smooth"})},[a]),p.useEffect(()=>{S()},[m.userId,m.mock]),e.jsxs(o,{flex:"70",bg:L("gray.200","gray.dark"),borderRadius:"md",p:2,flexDirection:"column",children:[e.jsxs(o,{w:"full",h:12,alignItems:"center",gap:2,children:[e.jsx(k,{src:m.userProfilePic,size:"sm"}),e.jsxs(w,{display:"flex",alignItems:"center",children:[m.userName," ",e.jsx(I,{src:"/verified.png",w:4,h:4,ml:1})]})]}),e.jsx(de,{}),e.jsxs(o,{flexDir:"column",gap:4,my:4,p:2,height:"400px",overflowY:"auto",children:[t&&[...Array(5)].map((r,d)=>e.jsxs(o,{gap:2,alignItems:"center",p:1,borderRadius:"md",alignSelf:d%2===0?"flex-start":"flex-end",children:[d%2===0&&e.jsx(W,{size:7}),e.jsxs(o,{flexDir:"column",gap:2,children:[e.jsx(_,{h:"8px",w:"250px"}),e.jsx(_,{h:"8px",w:"250px"}),e.jsx(_,{h:"8px",w:"250px"})]}),d%2!==0&&e.jsx(W,{size:7})]},d)),!t&&a.map(r=>e.jsx(o,{direction:"column",ref:a.length-1===a.indexOf(r)?h:null,children:e.jsx(ge,{message:r,ownMessage:u._id===r.sender})},r._id))]}),e.jsx(fe,{setMessages:i})]})},be=()=>{const[x,t]=p.useState(""),n=g(s=>s.conversation.getConversation),a=g(s=>s.socketio.socket),i=g(s=>s.socketio.onlineUsers),u=g(s=>s.conversation.getSelectedConversation),c=g(s=>s.user.userInfo),f=R(),{isLoading:h,setLoading:m}=A(),[j,S]=p.useState(!0),v=B(),r=async()=>{try{const s=await z.get("/api/messages/conversations");f(C(s.data))}catch(s){v("Error",s.response.data.error,"error")}finally{S(!1)}},d=async s=>{s.preventDefault();try{const l=await z.get(`./api/users/profile/${x}`);if(l.data._id===c._id){v("Error","You cannot message yourself","error");return}const U=n.find($=>$.participants[0]._id===l.data._id);if(U){f(G({_id:U._id,userId:l.data._id,userName:l.data.userName,userProfilePic:l.data.profilePic}));return}const Y={mock:!0,lastMessage:{text:"",sender:""},_id:Date.now(),participants:[{_id:l.data._id,userName:l.data.userName,profilePic:l.data.profilePic}]};f(C([...n,Y]))}catch(l){v("Error",l.response.data.error,"error")}finally{m(!1)}};return p.useEffect(()=>{a==null||a.on("messagesSeen",({conversationId:s})=>{f(C(n.map(l=>l._id===s?{...l,lastMessage:{...l.lastMessage,seen:!0}}:l)))})},[a,C]),p.useEffect(()=>{r()},[]),e.jsx(M,{position:"absolute",left:"50%",w:{base:"100%",md:"80%",lg:"750px"},p:4,transform:"translateX(-50%)",children:e.jsxs(o,{gap:4,flexDirection:{base:"column",md:"row"},maxW:{sm:"400px",md:"full"},mx:"auto",children:[e.jsxs(o,{flex:30,gap:2,flexDirection:"column",maxW:{sm:"250px",md:"full"},mx:"auto",children:[e.jsx(w,{fontWeight:700,color:L("gray.600","gray.400"),children:"Your Conversations"}),e.jsx("form",{onSubmit:d,children:e.jsxs(o,{alignItems:"center",gap:2,children:[e.jsx(E,{placeholder:"Search for a user",onChange:s=>t(s.target.value)}),e.jsx(ae,{size:"sm",onClick:d,isLoading:h,children:e.jsx(me,{})})]})}),j&&[0,1,2,3,4].map((s,l)=>e.jsxs(o,{gap:4,alignItems:"center",p:"1",borderRadius:"md",children:[e.jsx(M,{children:e.jsx(W,{size:"10"})}),e.jsxs(o,{w:"full",flexDirection:"column",gap:3,children:[e.jsx(_,{h:"10px",w:"80px"}),e.jsx(_,{h:"8px",w:"90%"})]})]},l)),!j&&(n==null?void 0:n.map(s=>e.jsx(he,{isOnline:i.includes(s.participants[0]._id),conversation:s},s._id)))]}),!u._id&&e.jsxs(o,{flex:70,borderRadius:"md",p:2,flexDir:"column",alignItems:"center",justifyContent:"center",height:"400px",children:[e.jsx(pe,{size:100}),e.jsx(w,{fontSize:20,children:"Select a conversation to start messaging"})]}),u._id&&e.jsx(ve,{})]})})};export{be as default};
